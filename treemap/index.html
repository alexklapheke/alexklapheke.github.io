<!DOCTYPE html>
<html lang="en-US">
	<head>
		<title>Cambridge Tree Map</title>

		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
		<link rel="apple-touch-icon" href="apple-touch-icon.png">
		<meta name="apple-mobile-web-app-title" content="Cambridge Tree Map">
		<meta name="msapplication-TileColor" content="#2c501f">
		<meta name="msapplication-TileImage" content="tile-icon.png">

		<meta name="author" content="Alexander Klapheke">
		<link rel="canonical" href="http://alexklapheke.github.io/treemap">

		<link rel="stylesheet" type="text/css" href="../include/style.css">
		<style type="text/css" media="all">
			body {
				background: #dfe8f7;
			}

			main, #map, #map svg {
				overflow: hidden;
			}

			#map {
				border: 1px solid #888888;
				background: #fafafa;
			}

			#map.loading {
				background-color: #e8e8e8;
			}

			.loadingtext, noscript {
				font-size: 28px;
				margin: auto;
			}

			main {
				padding: 30px 0px 30px 30px;
				margin-left: 280px;
				background: #ffffff;
			}

			footer {
				padding: 30px;
				margin-left: 280px;
				background: #DFE8F7;
			}

			.sci {
				font-style: italic;
			}

			label svg {
				margin: 0pt 2pt;
			}

			g.baselayer, g.treelayer {
				transition: opacity 0.5s ease;
			}

			.dimmed {
				opacity: 0.2;
			}

			.close {
				color: #081220;
				margin-left: 5pt;
				font-style: normal;
			}

			.help, .help a {
				font-size: 10pt;
			}

			@media only screen and (max-width: 960px){
				header {
					position: static;
					width: auto;
				}
				
				main, footer {
					margin-left: 0px;
				}
				
				main, header {
					padding: 30px;
				}
				
				#map {
					max-width: 100%;
				}
			}

		</style>
		<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
		<script src="https://d3js.org/d3.v6.min.js"></script>
		<script>
			// TODO: Fix dot sizes, especially when zoomed in
			// TODO: Clean up specific names
			// TODO: Mobile-friendly layout
			// TODO: Add street names (only when zoomed in enough?) <https://www.cambridgema.gov/GIS/gisdatadictionary/Trans/TRANS_MajorRoads>

			var width = 1000;
			var height = 800;
			var numBoxes = 0;
			var trees;

			var projection = d3.geoMercator();
			var geoGenerator = d3.geoPath().projection(projection)

			// Cycle through colors
			function colors(i) {
				var colorlist = ["#1b9e77", "#d95f02", "#7570b3", "#e7298a", "#66a61e", "#e6ab02", "#a6761d", "#666666"]
				return colorlist[i % colorlist.length]
			}

			// Format user-provided scientific name with proper capitalization etc.
			function formatName(sci) {
				var s = sci.trim().split(" ")
				var g = s.shift()
				var genus = g[0].toUpperCase() + g.substring(1).toLowerCase()
				var species = s.join(" ").toLowerCase()
				return species ? genus + " " + species : genus
			}

			// Load basemaps
			function setupMap() {
				var map = d3.select("#map")
					.style("width", width + "px")
					.style("height", height + "px");

				var span = map.append("span")
					.classed("loadingtext", true)
					.text("Loading basemaps...")

				// <https://observablehq.com/@d3/zoom>
				var svg = map.append("svg")
					.style("width", width + "px")
					.style("height", height + "px")

				var g = svg.append("g")
					.attr("id", "mapwrapper")

					svg.call(d3.zoom()
						.extent([
							[0, 0],
							[width, height]
						])
						.scaleExtent([1, 8])
						.on("zoom", function({
							transform
						}) {
							g.attr("transform", transform);
						}));


				var shapes = [
					{"id": "Boundary",   "color": "#fffaf0" }, // was: 
					{"id": "Vegetation", "color": "#73d05f" },
					{"id": "OpenSpace",  "color": "#73d05f" },
					{"id": "Water",      "color": "#bdd1ee" },
					{"id": "Roads",      "color": "#333e47" },
					{"id": "Paths",      "color": "#333e47" },
				]

				// <https://stackoverflow.com/a/51113326>
				Promise.all([
					d3.json("BOUNDARY_CityBoundary.json"),
					d3.json("BASEMAP_Vegetation.json"),
					d3.json("RECREATION_OpenSpace.json"),
					d3.json("HYDRO_WaterBodies.json"),
					d3.json("BASEMAP_Roads.json"),
					d3.json("BASEMAP_PublicFootpaths.json"),
				]).then(function(jsons) {
					for (var i = 0, len = jsons.length; i < len; i++) {
						var json = jsons[i]
						var shape = shapes[i]
						d3.select("#mapwrapper")
							.append("g")
							.attr("id", shape.id)
							.classed("baselayer", true)
							.selectAll("path")
							.data(json.features)
							.enter()
							.append("path")
							.attr("d", geoGenerator)
							.attr("fill", shape.color)
							.classed("basepath", true)
					}
					map.classed("loading", false);
					span.remove();
				});
			}

			function addTrees(sci, col) {
				var sci = formatName(sci)
				var sci_class = sci.replace(" ", "_")

				d3.select("#mapwrapper")
					.append("g")
					.attr("id", "layer_" + sci_class)
					.classed("treelayer", true)
					.selectAll("path")
					.data(trees.features)
					.enter()
					.filter(function(tree) {
						if (sci.indexOf(" ") == -1) {
							return tree.properties.Genus == sci
						} else {
							var s = sci.split(" ")
							return (tree.properties.Genus == s[0]) && (tree.properties.species == s[1])
						}
					})
					.append("path")
					.attr("d", function(tree) {
						return geoGenerator.pointRadius(2.5 * Math.log10(tree.properties.diameter))(tree)
					})
					.attr("fill", col)
					.attr("stroke", "#000")
					.classed(sci_class, true)
					.classed("treepath", true)
			}

			function showTrees(sci) {
				var sci = formatName(sci)
				var sci_class = sci.replace(" ", "_")
				d3.select("#layer_" + sci_class).style("opacity", 1);
			}

			function hideTrees(sci) {
				var sci = formatName(sci)
				var sci_class = sci.replace(" ", "_")
				d3.select("#layer_" + sci_class).style("opacity", 0);
			}

			function deleteTrees(sci) {
				var sci = formatName(sci)
				var sci_class = sci.replace(" ", "_")
				d3.select("#layer_" + sci_class).remove();
				d3.select("#box_" + sci_class).remove();
				d3.select("#label_" + sci_class).remove();
				// numBoxes--;
				return false;
			}

			function toggleTrees(box, sci, col) {
				if (box.checked) {showTrees(sci, col)} else {hideTrees(sci)}
				return false;
			}

			function dimBasemap(elem) {
				if (elem.checked) {
					d3.selectAll("g.baselayer").classed("dimmed", true);
				} else {
					d3.selectAll("g.baselayer").classed("dimmed", false);
				}
				return true;
			}

			function addBox(sci) {
				var sci = formatName(sci)
				var sci_class = sci.replace(" ", "_")

				// Don't clutter with many boxes with the same label
				var box = d3.select("#box_" + sci_class)
				if (!box.empty()) {
					box.attr("checked", true);
					return false;
				}

				var col = colors(numBoxes)

				var div = d3.select("#form").append("div")
				div.append("input")
					.attr("type", "checkbox")
					.attr("name", "box_" + sci_class)
					.attr("id", "box_" + sci_class)
					.attr("checked", true)
					.on("click", function(){return toggleTrees(this, sci, col)})

				var label = div.append("label")
					.attr("for", "box_" + sci_class)
					.attr("id", "label_" + sci_class)
					.classed("sci", true)
					.text(sci)

				var svg = label.append("svg")
					.attr("width", 12)
					.attr("height", 12)
					.lower()
				svg.append("circle")
					.attr("cx", 6)
					.attr("cy", 6)
					.attr("r", 6)
					.attr("fill", col)

				label.append("a")
					.attr("href", "#")
					.attr("title", "Remove")
					.classed("close", true)
					.on("click", function(){return deleteTrees(sci)})
					.text("✕")

				numBoxes++;

				addTrees(sci, col);
				return false;
			}

			d3.json("trees.json").then(function(json) {
				trees = json;
				projection.fitSize([width, height], json);
				setupMap();
			});
		</script>
	</head>
	<body>

	<header>
		<form id="form" action="#" onsubmit="return addBox(this.genus.value)">
			<p class="help">Type the scientific name of a tree below and hit enter to add it to the map. For example, <a href="#" onclick="return addBox('Ulmus pumila')"><abbr class="sci" title="Siberian elm">Ulmus pumila</abbr></a>, <a href="#" onclick="return addBox('Tilia tomentosa')"><abbr class="sci" title="Silver linden">Tilia tomentosa</abbr></a>, or <a href="#" onclick="return addBox('Phellodendron amurense')"><abbr class="sci" title="Amur cork tree">Phellodendron amurense</abbr></a>.</p>
			<input type="text" name="genus" id="genus" value="" size="30" placeholder="Scientific name" list="genera">
			<datalist id="genera">
				<option value="Abies">
				<option value="Abies concolor">
				<option value="Acer">
				<option value="Acer acerifolia">
				<option value="Acer americana">
				<option value="Acer buergerianum">
				<option value="Acer campestre">
				<option value="Acer cordata">
				<option value="Acer freemanii">
				<option value="Acer ginnala">
				<option value="Acer griseum">
				<option value="Acer negundo">
				<option value="Acer platanoides">
				<option value="Acer rubra">
				<option value="Acer rubrum">
				<option value="Acer saccharinum">
				<option value="Acer saccharum">
				<option value="Acer tataricum">
				<option value="Aesculus">
				<option value="Aesculus hippocastanum">
				<option value="Aesculus × carnea">
				<option value="Ailanthus">
				<option value="Ailanthus altissima">
				<option value="Amelanchier">
				<option value="Amelanchier ginnala">
				<option value="Amelanchier × grandiflora">
				<option value="Betula">
				<option value="Betula nigra">
				<option value="Betula papyrifera">
				<option value="Betula pendula">
				<option value="Carpinus">
				<option value="Carpinus caroliniana">
				<option value="Carya">
				<option value="Carya platanoides">
				<option value="Castanea">
				<option value="Castanea hippocastanum">
				<option value="Catalpa">
				<option value="Catalpa speciosa">
				<option value="Cedrus">
				<option value="Celtis">
				<option value="Celtis occidentalis">
				<option value="Cercidiphyllum">
				<option value="Cercis">
				<option value="Cercis canadensis">
				<option value="Chionanthus">
				<option value="Cladrastis">
				<option value="Cladrastis kentukea">
				<option value="Cornus">
				<option value="Cornus kousa">
				<option value="Corylus">
				<option value="Corylus colurna">
				<option value="Cotinus">
				<option value="Crataegus">
				<option value="Enkianthus">
				<option value="Eucommia">
				<option value="Eucommia ulmoides">
				<option value="Fagus">
				<option value="Fagus grandifolia">
				<option value="Fagus sylvatica">
				<option value="Fraxinus">
				<option value="Fraxinus americana">
				<option value="Fraxinus excelsior">
				<option value="Fraxinus pennsylvanica">
				<option value="Ginkgo">
				<option value="Ginkgo biloba">
				<option value="Ginkgo triacanthos">
				<option value="Gleditsia">
				<option value="Gleditsia japonica">
				<option value="Gleditsia palustris">
				<option value="Gleditsia triacanthos">
				<option value="Gymnocladus">
				<option value="Gymnocladus dioicus">
				<option value="Halesia">
				<option value="Hamamelis">
				<option value="Ilex">
				<option value="Juglans">
				<option value="Juglans nigra">
				<option value="Juniperus">
				<option value="Juniperus virginiana">
				<option value="Koelreuteria">
				<option value="Koelreuteria paniculata">
				<option value="Laburnum">
				<option value="Larix">
				<option value="Liquidambar">
				<option value="Liquidambar styraciflua">
				<option value="Liriodendron">
				<option value="Liriodendron tulipfera">
				<option value="Maackia">
				<option value="Maackia amurensis">
				<option value="Magnolia">
				<option value="Malus">
				<option value="Metasequoia">
				<option value="Metasequoia glyptostroboides">
				<option value="Morus">
				<option value="Morus alba">
				<option value="Nyssa">
				<option value="Nyssa sylvatica">
				<option value="Ostrya">
				<option value="Ostrya virginiana">
				<option value="Oxydendrum">
				<option value="Parrotia">
				<option value="Parrotia persica">
				<option value="Phellodendron">
				<option value="Phellodendron amurense">
				<option value="Picea">
				<option value="Picea abies">
				<option value="Picea glauca">
				<option value="Picea pungens">
				<option value="Pinus">
				<option value="Pinus nigra">
				<option value="Pinus parviflora">
				<option value="Pinus rubrum">
				<option value="Pinus sylvestris">
				<option value="Platanus">
				<option value="Platanus acerifolia">
				<option value="Platanus occidentalis">
				<option value="Populus">
				<option value="Populus deltoides">
				<option value="Populus nigra">
				<option value="Populus tremuloides">
				<option value="Prunus">
				<option value="Prunus americana">
				<option value="Prunus calleryana">
				<option value="Prunus canadensis">
				<option value="Prunus cordata">
				<option value="Prunus incam">
				<option value="Prunus pensylvanica">
				<option value="Prunus persica">
				<option value="Prunus platanoides">
				<option value="Prunus sargentii">
				<option value="Prunus serotina">
				<option value="Prunus serrulata">
				<option value="Prunus virginiana">
				<option value="Prunus yedoensis">
				<option value="Prunus × incamp">
				<option value="Pseudotsuga">
				<option value="Pseudotsuga menziesii">
				<option value="Ptelea">
				<option value="Ptelea trifoliata">
				<option value="Pyrus">
				<option value="Pyrus calleryana">
				<option value="Pyrus cordata">
				<option value="Quercus">
				<option value="Quercus alba">
				<option value="Quercus bicolor">
				<option value="Quercus imbricaria">
				<option value="Quercus palustris">
				<option value="Quercus robur">
				<option value="Quercus rubra">
				<option value="Rhamnus">
				<option value="Rhamnus cathartica">
				<option value="Robinia">
				<option value="Robinia pseudoacacia">
				<option value="Salix">
				<option value="Salix babylonica">
				<option value="Salix nigra">
				<option value="Sassafras">
				<option value="Sciadopitys">
				<option value="Sorbus">
				<option value="Stewartia">
				<option value="Styphnolobium">
				<option value="Styphnolobium japonica">
				<option value="Styphnolobium japonicum">
				<option value="Styphnolobium triacanthos">
				<option value="Styrax">
				<option value="Syringa">
				<option value="Syringa reticulata">
				<option value="Syringa serrata">
				<option value="Syringa styraciflua">
				<option value="Taxus">
				<option value="Thuja">
				<option value="Thuja occidentalis">
				<option value="Tilia">
				<option value="Tilia calleryana">
				<option value="Tilia cordata">
				<option value="Tilia rubrum">
				<option value="Tilia tomentosa">
				<option value="Tsuga">
				<option value="Tsuga canadensis">
				<option value="Ulmus">
				<option value="Ulmus americana">
				<option value="Ulmus bicolor">
				<option value="Ulmus cordata">
				<option value="Ulmus japonica× wilsoniana">
				<option value="Ulmus parvifolia">
				<option value="Ulmus pumila">
				<option value="Ulmus serrata">
				<option value="Viburnum">
				<option value="Zelkova">
				<option value="Zelkova parvifolia">
				<option value="Zelkova serrata">
			</datalist>
			<br>
			<input type="checkbox" name="dimmer" id="dimmer" onclick="return dimBasemap(this)">
			<label for="dimmer">Dim basemap</label>
			<br><br>
		</form>
	</header>
	<main role="main">
		<h1>Cambridge Tree Map</h1>
		<div id="map" class="loading">
			<noscript>
				<p>Sorry, this map relies on <a href="https://d3js.org/">D3.js</a>, so it won't work without JavaScript enabled.</p>
			</noscript>
		</div>
	</main>

	<footer>
	Created by <a href="https://alexklapheke.github.io">Alexander Klapheke</a>.
	Tree data is from the <a href="https://data.cambridgema.gov/Public-Works/Street-Trees/ni4i-5bnn">Cambridge Open Data portal</a>.
	Basefiles are from <a href="https://www.cambridgema.gov/GIS">Cambridge GIS</a>.
	Erroneous tree diameters are fixed (to the best of my knowledge) but not erroneous genus or species labels.
	The color scheme is from <a href="https://colorbrewer2.org/">ColorBrewer</a>.
	This code is released under the <a rel="license" href="https://mit-license.org/">MIT license</a>.
	For more information, see <a href="https://alexklapheke.github.io/blog/trees.html">my blog post</a> on the subject.
	</footer>
	</body>
</html>
